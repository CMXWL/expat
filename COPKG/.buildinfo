/* target information */
@import "version.inc";


#product-info  {
	product-name: "expat";
	version: "2.0.1";
	original-source-location: "http://sourceforge.net/projects/expat/files/expat/2.0.1/expat-2.0.1.tar.gz/download";
	original-source-website: "http://expat.sourceforge.net/";
	license: "MIT/X Consortium license";
	packager: "Hamish C";
}

test {
    set: PLAT="${PLAT??x86, x64}";
    default : false;
    build-command: @"
        if ""${BUILT}"" neq ""true"" ptk release --nologo --COMP=""${COMP}"" --PLAT=""${PLAT}""

        for %%A in (${PLAT}) do (
            win32\bin\%%A\Release\expat_tests.exe || goto failed
        )
	";
};

package {
    set: COMP="${COMP??vc10}";
    set: PLAT="${PLAT??x86, x64}";
    default : false;
    uses : sign;
    
    targets: { 
        @"copkg\expat[vc10]-${package-version}-x86.msi",
        @"copkg\expat-dev[vc10]-${package-version}-x86.msi",
        @"copkg\expat-dev-common-${package-version}-any.msi",
        @"copkg\expat[vc10]-${package-version}-x64.msi",
        @"copkg\expat-dev[vc10]-${package-version}-x64.msi"
    };
    
    build-command : @"
        cd COPKG
        autopackage expat-dev-common.autopkg || goto failed
        for %%a in (${COMP}) do (
            for %%b in (${PLAT}) do (
                autopackage --comp=%%a --plat=%%b expat.autopkg expat-dev.autopkg || goto failed
            )
        )
        ptk update-version
    ";

	clean-command: @"del COPKG\*.msi COPKG\*.wixpdb";
	
};


update-version {
    default : false;
    
    build-command : @"
        REM auto-increment version.inc file...
        
        cd COPKG
        setlocal EnableDelayedExpansion
        for /F ""tokens=4,5,6,7  delims=.; "" %%v in (version.inc) do (
            set /a build=%%y + 1
            set VERSTRING=#define { package-version: %%v.%%w.%%x.!build!; }
        )
        echo !VERSTRING! > version.inc
    ";
}

release {
    set: {
		BuildCfg="Release";
        COMP="${COMP??vc10}";
		PLAT="${PLAT??x86, x64}";
	};
	build-command: @"
        for %%A in (${COMP}) do (
            for %%B in (${PLAT}) do (
                ptk --nologo base --COMP=%%A --PLAT=%%B --BuildCfg=${BuildCfg} || goto failed
            )
        )
	";
};

sign {
    set: {
        COMP="${COMP??vc10}";
		PLAT="${PLAT??x86, x64}";
    };
    default : false;
    build-command: @"
        if ""${BUILT}"" neq ""true"" ptk release --nologo --COMP=""${COMP}"" --PLAT=""${PLAT}""

        for %%A in (${PLAT}) do (
            simplesigner.exe --nologo --sign win32\bin\%%A\Release\**.dll win32\bin\%%A\Release\**.exe
        )
    ";
};


base {
    set: {
        BuildCfg="${BuildCfg??Release}";
        COMP="${COMP??vc10}";
		PLAT="${PLAT??x86}";
    };
    default : false;
    compiler: ${COMP};
    platform: ${PLAT};
    
    targets: { 
		"win32\bin\${PLAT}\Release\libexpat.dll",
		"win32\bin\${PLAT}\Release\libexpat.exp",
		"win32\bin\${PLAT}\Release\libexpat.lib",
		"win32\bin\${PLAT}\Release\libexpatMT.lib",
		"win32\bin\${PLAT}\Release\libexpatw.dll",
		"win32\bin\${PLAT}\Release\libexpatw.exp",
		"win32\bin\${PLAT}\Release\libexpatw.lib",
		"win32\bin\${PLAT}\Release\libexpatwMT.lib",
		"win32\bin\${PLAT}\Release\xmlwf.exe",
		"win32\bin\${PLAT}\Release\outline.exe",
		"win32\bin\${PLAT}\Release\elements.exe",
	};
	
    build-command:@"
        REM this makes it so that DLLs can have their own SxS Activation Context in an embedded resource.
		echo %_CL% | findstr ISOLATION_AWARE || set _CL=%CL% /D ISOLATION_AWARE_ENABLED

        if ""${PLAT}"" == ""x86"" (
            msbuild /p:Platform=win32 /p:Configuration=${BuildCfg} expat.sln
        ) else (
            msbuild /p:Platform=${PLAT} /p:Configuration=${BuildCfg} expat.sln
        )
	";
    
    clean-command:@"
       if exist win32\bin rmdir /s /q win32\bin > nul 2> nul
       if exist ipch rmdir /s /q ipch > nul 2> nul
       if exist win32\tmp rmdir /s /q win32\tmp > nul 2> nul
       del /S /Q /A - *.sdf *.suo *.user *.exe *.pdb > nul 2>NUL
    ";
};
